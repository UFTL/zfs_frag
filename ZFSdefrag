Not sure how to get in touch with you, please remove this file if it's not of use to you. If it is, feel free to use it.

You asked how to defrag ZFS... I detach, reattach, resilver, scrub then initialize all drives in a mirrored pool... that should defrag each drive in turn
(as the drive is reattached, resilvered and scrubbed), and it zeros the unused sectors so your compressed backups (for full backups or VMs) are much
smaller. Due to the small installed size of my OS, I can compress a 1 TB .img file of a drive down to 2.4 GB. Without zeroing the unused sectors, it's
more than 8 GB.

This is set up as a keyboard shortcut one-line-script, run under the installed OS. When it's done, I then reboot to the LiveCD version of the OS, backup
the drives to .img files and compress those backups into .img.7z files.

gnome-terminal -- /bin/sh -c 'echo Detaching b6fc7ef9-d8a7-2d4a-810e-d58d4fbd7e13...; sudo zpool detach rpool b6fc7ef9-d8a7-2d4a-810e-d58d4fbd7e13; sleep 60; echo Attaching b6fc7ef9-d8a7-2d4a-810e-d58d4fbd7e13...; sudo zpool attach rpool e5457ac9-50c8-48a1-adb1-a5b88e364349 b6fc7ef9-d8a7-2d4a-810e-d58d4fbd7e13; sleep 15; while sudo zpool status | grep "resilver in progress" > /dev/null; do clear; sudo zpool status -Td; sleep 2; done; clear; sleep 10; sudo zpool events -c; sudo zpool scrub bpool; sudo zpool scrub rpool; while sudo zpool status | grep "scan: *scrub in progress" > /dev/null; do clear; sudo zpool status -Td; sleep 2; done; clear; sudo zpool status -Td; sleep 15; clear; echo Detaching e5457ac9-50c8-48a1-adb1-a5b88e364349...; sudo zpool detach rpool e5457ac9-50c8-48a1-adb1-a5b88e364349; sleep 60; echo Attaching e5457ac9-50c8-48a1-adb1-a5b88e364349...; sudo zpool attach rpool b6fc7ef9-d8a7-2d4a-810e-d58d4fbd7e13 e5457ac9-50c8-48a1-adb1-a5b88e364349; sleep 15; while sudo zpool status | grep "resilver in progress" > /dev/null; do clear; sudo zpool status -Td; sleep 2; done; clear; sleep 10; sudo zpool events -c; sudo zpool scrub bpool; sudo zpool scrub rpool; while sudo zpool status | grep "scan: *scrub in progress" > /dev/null; do clear; sudo zpool status -Td; sleep 2; done; clear; sudo zpool status -Td; sleep 15; clear; echo Detaching cbabdc98-01...; sudo zpool detach rpool cbabdc98-01; sleep 60; echo Attaching cbabdc98-01...; sudo zpool attach rpool b6fc7ef9-d8a7-2d4a-810e-d58d4fbd7e13 cbabdc98-01; sleep 15; while sudo zpool status | grep "resilver in progress" > /dev/null; do clear; sudo zpool status -Td; sleep 2; done; clear; sleep 10; sudo zpool events -c; sudo zpool scrub bpool; sudo zpool scrub rpool; while sudo zpool status | grep "scan: *scrub in progress" > /dev/null; do clear; sudo zpool status -Td; sleep 2; done; clear; sudo zpool status -Td; sleep 15; clear; set zfs:zfs_initialize_value=0; sudo zpool initialize bpool a7de746a-65ed-0f4d-b1cc-3e5a1d0c62b6; sudo zpool initialize rpool b6fc7ef9-d8a7-2d4a-810e-d58d4fbd7e13 e5457ac9-50c8-48a1-adb1-a5b88e364349 cbabdc98-01 be91092b-1335-4890-a38c-ba720b20f247 3870024e-8c4d-456a-9a49-29db1093c929; sleep 15; while sudo zpool status | grep "initializing" > /dev/null; do clear; sudo zpool status -Td; sleep 2; done; clear; sudo zpool status -Td; sleep 15; clear; echo Clearing sda2 swap...; sudo swapoff -v /dev/sda2; sleep 60; sudo dd if=/dev/zero of=/dev/sda2 bs=512 status=progress; sleep 60; sudo mkswap /dev/sda2 -U de1a46a0-1e14-4158-b93f-a94971d01683; sleep 60; sudo swapon -a; clear; echo Clearing sdb2 swap...; sudo swapoff -v /dev/sdb2; sleep 60; sudo dd if=/dev/zero of=/dev/sdb2 bs=512 status=progress; sleep 60; sudo mkswap /dev/sdb2 -U 8580f890-b596-4391-ac13-b727aabd50c5; sleep 60; sudo swapon -a; clear; echo Finished... reboot to Zorin OS USB stick to do backup.; sleep 30'
